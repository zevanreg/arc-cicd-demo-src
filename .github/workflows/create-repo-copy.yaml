name: Clone and Configure Repo

on:
  workflow_dispatch:
    inputs:
      new_repo_name:
        description: 'Optional: Name of the new repository'
        required: false

jobs:
  clone-and-configure:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.ADMIN_PAT }}
      GITOPS_REPO: "arc-cicd-demo-gitops"

    steps:
    - name: Set dynamic repo name
      id: set-name
      run: |
        DATE=$(date +%Y%m%d)
        CURRENT_REPO=$(basename "$GITHUB_REPOSITORY")
        OWNER=$(cut -d'/' -f1 <<< "$GITHUB_REPOSITORY")
        DEFAULT_NAME="${CURRENT_REPO}-${DATE}"
        TARGET_GITOPS_REPO="${GITOPS_REPO}-${DATE}"

        if [ -z "${{ github.event.inputs.new_repo_name }}" ]; then
          REPO_NAME="$DEFAULT_NAME"
        else
          REPO_NAME="${{ github.event.inputs.new_repo_name }}"
        fi

        echo "TARGET_REPO=$OWNER/$REPO_NAME" >> $GITHUB_ENV
        echo "TARGET_GITOPS_REPO=$OWNER/$TARGET_GITOPS_REPO" >> $GITHUB_ENV
        echo "Repository to be created: $OWNER/$REPO_NAME"

    - name: Clone current repo into temp dir
      run: |
        git clone https://github.com/${GITHUB_REPOSITORY}.git temp-repo
        cd temp-repo
        git remote remove origin

    - name: Create new repo from temp dir
      run: |
        cd temp-repo
        gh repo create "$TARGET_REPO" --public --source=. --push
        sleep 5
        gh repo view "$TARGET_REPO" || exit 1

    - name: Debug secret lengths
      run: |
        echo "AKS_NAME length: ${#{{ secrets.AKS_NAME }}}"
        echo "AZURE_CREDENTIALS length: ${#{{ secrets.AZURE_CREDENTIALS }}}"

    - name: Set secrets in new repo
      run: |
        for secret in AKS_NAME AKS_RESOURCE_GROUP AZURE_CREDENTIALS AZ_ACR_NAME MANIFESTS_BRANCH MANIFESTS_FOLDER PAT VOTE_APP_TITLE; do
          VALUE="${{ secrets[secret] }}"
          if [ -n "$VALUE" ]; then
            gh secret set "$secret" --body "$VALUE" --repo "$TARGET_REPO"
          else
            echo "Warning: Secret $secret is empty or not set."
          fi
        done
        gh secret set MANIFESTS_REPO --body "https://github.com/${TARGET_GITOPS_REPO}" --repo "$TARGET_REPO"

    - name: Create environments and set environment secrets
      run: |
        for env in az-vote-app-dev az-vote-app-stage; do
          gh api --method PUT "/repos/$TARGET_REPO/environments/$env"
          gh secret set ENVIRONMENT_NAME --env "$env" --body "${{ secrets.ENVIRONMENT_NAME }}" --repo "$TARGET_REPO"
          gh secret set TARGET_NAMESPACE --env "$env" --body "${{ secrets.TARGET_NAMESPACE }}" --repo "$TARGET_REPO"
        done

    - name: Clone gitops repo into temp dir
      run: |
        git clone https://github.com/Azure/${GITOPS_REPO}.git temp-gitops-repo
        cd temp-gitops-repo
        git remote remove origin

    - name: Create new gitops repo from temp dir
      run: |
        cd temp-gitops-repo
        gh repo create "$TARGET_GITOPS_REPO" --public --source=. --push
